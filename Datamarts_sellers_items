/*CREATE OR REPLACE TABLE  EXPLOTACION.STAGING_DM_SELLERS_ITEMS 
PARTITION BY
  RANGE_BUCKET(CUS_CUST_ID, GENERATE_ARRAY(0, 100000000000, 10000000))
CLUSTER BY SIT_SITE_ID, CUS_CUST_ID
AS (

SELECT I.SIT_SITE_ID,
        CUS_CUST_ID_SEL CUS_CUST_ID,
        DATE_DIFF(CURRENT_DATE,MIN(DATE(ITE_ITEM_AUCTION_START_DATETIME)), DAY) as DAYS_FIRST_PUBLICATION,
        DATE(MIN(ITE_ITEM_AUCTION_START_DATETIME)) as CUS_FIRST_PUBLICATION,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID = 'me1' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITEMS_ME1,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID = 'me2' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITEMS_ME2,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID IN ('me1','me2') AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITEMS_ME,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) LL,
        COUNT(DISTINCT CASE WHEN DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 7 AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) LL_LAST_7DAYS,
        COUNT(DISTINCT CASE WHEN DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 30 AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) LL_LAST_30DAYS,
        COUNT(DISTINCT CASE WHEN DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 30  THEN I.ITE_ITEM_ID END) PUBLICATION_LAST_30DAYS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CONDITION='new' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END ) LL_NEW_ACTIVE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CONDITION='new'  THEN I.ITE_ITEM_ID END ) LL_NEW,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CONDITION='used'  THEN I.ITE_ITEM_ID END ) LL_USED,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_PAYMENT_TYPE_ID='free_shipping' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) ITEMS_FREE_SHIPPING,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_PAYMENT_TYPE_ID='free_shipping'AND ITE_ITEM_SHIPPING_MODE_ID = 'me2' AND I.ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) ITEMS_FREE_SHIPPING_AND_ME2 ,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_LOGISTIC_TYPE ='fulfillment' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) ITEMS_FULL_ACTIVE,
        COUNT(DISTINCT CASE WHEN I.SIT_SITE_ID in ('MLU','MPE','MLV') AND ITE_ITEM_LISTING_TYPE_ID_NW = 'gold_special' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID
        WHEN I.SIT_SITE_ID in ('MLA','MLB','MLM','MCO','MLC') AND ITE_ITEM_LISTING_TYPE_ID_NW = 'gold_pro' THEN I.ITE_ITEM_ID END) FLAG_PREMIUM,
        COUNT(DISTINCT CASE WHEN I.SIT_SITE_ID in ('MLU','MPE','MLV') AND ITE_ITEM_LISTING_TYPE_ID_NW = 'bronze' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID
        WHEN I.SIT_SITE_ID in ('MLA','MLB','MLM','MCO','MLC') AND ITE_ITEM_LISTING_TYPE_ID_NW = 'gold_special' THEN I.ITE_ITEM_ID END) FLAG_CLASSIC,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_LISTING_TYPE_ID_NW = 'free' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) FLAG_FREE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_DEAL_IDS IS NOT NULL AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITEMS_DEAL_ACTIVE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CATALOG_LISTING_FLG=true AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) AS ITEMS_ACT_CATALOG,
        SUM(ITE_ITEM_VARIATION_QTY ) AS N_ITEMS_VARIATIONS,
        COUNT(DISTINCT CASE WHEN 'poor_quality_picture' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_PQP,
        COUNT(DISTINCT CASE WHEN 'catalog_listing_eligible' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) ITEMS_ELIGIBLE_CATALOG,
        COUNT(DISTINCT CASE WHEN 'incomplete_technical_specs' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) INCOMPLT_TECH_SPECS,
        COUNT(DISTINCT CASE WHEN 'not_market_price' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITE_NOT_MARKET_PRICE,
        COUNT(DISTINCT CASE WHEN ('deal_of_the_day' IN UNNEST(ITE_ITEM_TAGS_JSON) OR 'lightning_deal' IN UNNEST(ITE_ITEM_TAGS_JSON)) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) OFFERS_ACTIVE,
        COUNT(DISTINCT CASE WHEN 'self_service_in' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) NOT_FLEX_NOT_FULL,
        COUNT(DISTINCT CASE WHEN 'me2_available' IN UNNEST(ITE_ITEM_SHIPPING_TAGS)  THEN I.ITE_ITEM_ID END)  N_ITEMS_ME_AVAILABLE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID = 'me2' AND 'self_service_in' IN UNNEST(ITE_ITEM_SHIPPING_TAGS) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_FLEX_ITEMS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID = 'me2' AND ITE_ITEM_STATUS = 'active'  THEN I.ITE_ITEM_ID END)-COUNT(DISTINCT CASE WHEN  ITE_ITEM_STATUS = 'active' AND 'self_service_in' IN UNNEST(ITE_ITEM_SHIPPING_TAGS)  THEN I.ITE_ITEM_ID END) N_ITEMS_FLEX_ELIGIBLE,
        COUNT(DISTINCT CASE WHEN (SAFE_DIVIDE(I.ITE_ITEM_CURRENT_PRICE,F.CCO_TC_VALUE)) >150 AND ITE_ITEM_STATUS = 'active' AND ITE_ITEM_LISTING_TYPE_ID_NW NOT IN ('gold_pro','gold_special') THEN I.ITE_ITEM_ID END) N_ITEMS_150_USD_NO_PSJ,
        SUM(CASE WHEN V.ITE_ITEM_ID IS NOT NULL THEN QTY_VISITS END) QTY_VISITS,
        SUM(CASE WHEN V.ITE_ITEM_ID IS NOT NULL AND V.TIM_DAY>= CURRENT_DATE - 7 AND V.TIM_DAY < current_date()  THEN QTY_VISITS END) QTY_VISITS_LAST_7DAYS,
        SUM(CASE WHEN V.ITE_ITEM_ID IS NOT NULL AND V.TIM_DAY>= CURRENT_DATE - 30 AND V.TIM_DAY < current_date()  THEN QTY_VISITS END) QTY_VISITS_LAST_30DAYS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_QUANTITY_AVAILABLE=0 THEN I.ITE_ITEM_ID END ) ITE_ITEM_QUANTITY_AVAILABLE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_QUANTITY_AVAILABLE=0 AND DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 7 AND DATE(ITE_ITEM_AUCTION_START_DATETIME) < current_date() THEN ITE_ITEM_QUANTITY_AVAILABLE END )ITE_ITEM_QUANTITY_AVAILABLE_L7DAYS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_QUANTITY_AVAILABLE=0 AND DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 30 AND DATE(ITE_ITEM_AUCTION_START_DATETIME) < current_date() THEN ITE_ITEM_QUANTITY_AVAILABLE END )ITE_ITEM_QUANTITY_AVAILABLE_L30DAYS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CATALOG_LISTING_FLG=true AND ITE_ITEM_STATUS = 'active' AND CONCAT(I.SIT_SITE_ID,I.ITE_ITEM_ID) NOT IN (select coalesce(ITEM_ID,'0') from `meli-bi-data.WHOWNER.LK_BUYBOX_PRODUCT_STATUS`,UNNEST(ITE_ITEM_ID_WINNERS_SHARE)  ) THEN I.ITE_ITEM_ID END) AS ITEMS_LOSING_BB,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CATALOG_LISTING_FLG=true AND ITE_ITEM_STATUS = 'active' AND CONCAT(I.SIT_SITE_ID,I.ITE_ITEM_ID)  IN (select ITEM_ID from `meli-bi-data.WHOWNER.LK_BUYBOX_PRODUCT_STATUS`,UNNEST(ITE_ITEM_ID_WINNERS_SHARE) ) THEN I.ITE_ITEM_ID END) AS ITEMS_WINNER_BB

   FROM `meli-bi-data.WHOWNER.LK_ITE_ITEMS` I
LEFT JOIN  `meli-bi-data.WHOWNER.LK_CURRENCY_CONVERTION` F
   ON TRIM(F.SIT_SITE_ID) = I.SIT_SITE_ID
     AND tim_day_tc= CURRENT_DATE
LEFT JOIN WHOWNER.LK_ITE_ITEM_VISITS_RT V
  ON V.SIT_SITE_ID = I.SIT_SITE_ID
  AND V.ITE_ITEM_ID=I.ITE_ITEM_ID
    WHERE IS_TEST = FALSE
        AND I.SIT_SITE_ID IN ('MLA','MLC','MLB','MLM','MLU','MCO','MPE','MLV')
        AND ITE_ITEM_BUYING_MODE != 'classified'
    GROUP BY 1,2
);*/



CREATE OR REPLACE TABLE  EXPLOTACION.STAGING_DM_SELLERS_ITEMS
PARTITION BY
  RANGE_BUCKET(CUS_CUST_ID, GENERATE_ARRAY(0, 100000000000, 10000000))
CLUSTER BY SIT_SITE_ID, CUS_CUST_ID
AS (

SELECT I.SIT_SITE_ID,
        CUS_CUST_ID_SEL CUS_CUST_ID,
        DATE_DIFF(CURRENT_DATE,MIN(DATE(ITE_ITEM_AUCTION_START_DATETIME)), DAY) as DAYS_FIRST_PUBLICATION,
        DATE(MIN(ITE_ITEM_AUCTION_START_DATETIME)) as CUS_FIRST_PUBLICATION,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID = 'me1' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITEMS_ME1,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID = 'me2' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITEMS_ME2,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID IN ('me1','me2') AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITEMS_ME,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) LL,
        COUNT(DISTINCT CASE WHEN DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 7 AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) LL_LAST_7DAYS,
        COUNT(DISTINCT CASE WHEN DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 30 AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) LL_LAST_30DAYS,
        COUNT(DISTINCT CASE WHEN DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 30  THEN I.ITE_ITEM_ID END) PUBLICATION_LAST_30DAYS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CONDITION='new' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END ) LL_NEW_ACTIVE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CONDITION='new'  THEN I.ITE_ITEM_ID END ) LL_NEW,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CONDITION='used'  THEN I.ITE_ITEM_ID END ) LL_USED,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_PAYMENT_TYPE_ID='free_shipping' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) ITEMS_FREE_SHIPPING,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_PAYMENT_TYPE_ID='free_shipping'AND ITE_ITEM_SHIPPING_MODE_ID = 'me2' AND I.ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) ITEMS_FREE_SHIPPING_AND_ME2 ,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_LOGISTIC_TYPE ='fulfillment' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) ITEMS_FULL_ACTIVE,
        COUNT(DISTINCT CASE WHEN I.SIT_SITE_ID in ('MLU','MPE','MLV') AND ITE_ITEM_LISTING_TYPE_ID_NW = 'gold_special' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID
        WHEN I.SIT_SITE_ID in ('MLA','MLB','MLM','MCO','MLC') AND ITE_ITEM_LISTING_TYPE_ID_NW = 'gold_pro' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) FLAG_PREMIUM,
        COUNT(DISTINCT CASE WHEN I.SIT_SITE_ID in ('MLU','MPE','MLV') AND ITE_ITEM_LISTING_TYPE_ID_NW = 'bronze' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID
        WHEN I.SIT_SITE_ID in ('MLA','MLB','MLM','MCO','MLC') AND ITE_ITEM_LISTING_TYPE_ID_NW = 'gold_special' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) FLAG_CLASSIC,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_LISTING_TYPE_ID_NW = 'free' AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) FLAG_FREE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_DEAL_IDS IS NOT NULL AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITEMS_DEAL_ACTIVE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CATALOG_LISTING_FLG=true AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) AS ITEMS_ACT_CATALOG,
        SUM(ITE_ITEM_VARIATION_QTY ) AS N_ITEMS_VARIATIONS,
        COUNT(DISTINCT CASE WHEN 'poor_quality_picture' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_PQP,
        COUNT(DISTINCT CASE WHEN 'catalog_listing_eligible' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) ITEMS_ELIGIBLE_CATALOG,
        COUNT(DISTINCT CASE WHEN 'incomplete_technical_specs' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) INCOMPLT_TECH_SPECS,
        COUNT(DISTINCT CASE WHEN 'not_market_price' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_ITE_NOT_MARKET_PRICE,
        COUNT(DISTINCT CASE WHEN ('deal_of_the_day' IN UNNEST(ITE_ITEM_TAGS_JSON) OR 'lightning_deal' IN UNNEST(ITE_ITEM_TAGS_JSON)) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) OFFERS_ACTIVE,
        COUNT(DISTINCT CASE WHEN 'self_service_in' IN UNNEST(ITE_ITEM_TAGS_JSON) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) NOT_FLEX_NOT_FULL,
        COUNT(DISTINCT CASE WHEN 'me2_available' IN UNNEST(ITE_ITEM_SHIPPING_TAGS)  THEN I.ITE_ITEM_ID END)  N_ITEMS_ME_AVAILABLE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID = 'me2' AND 'self_service_in' IN UNNEST(ITE_ITEM_SHIPPING_TAGS) AND ITE_ITEM_STATUS = 'active' THEN I.ITE_ITEM_ID END) N_FLEX_ITEMS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_SHIPPING_MODE_ID = 'me2' AND ITE_ITEM_STATUS = 'active'  THEN I.ITE_ITEM_ID END)-COUNT(DISTINCT CASE WHEN  ITE_ITEM_STATUS = 'active' AND 'self_service_in' IN UNNEST(ITE_ITEM_SHIPPING_TAGS)  THEN I.ITE_ITEM_ID END) N_ITEMS_FLEX_ELIGIBLE,
        COUNT(DISTINCT CASE WHEN (SAFE_DIVIDE(I.ITE_ITEM_CURRENT_PRICE,F.CCO_TC_VALUE)) >150 AND ITE_ITEM_STATUS = 'active' AND ITE_ITEM_LISTING_TYPE_ID_NW NOT IN ('gold_pro','gold_special') THEN I.ITE_ITEM_ID END) N_ITEMS_150_USD_NO_PSJ,
        SUM(CASE WHEN V.ITE_ITEM_ID IS NOT NULL THEN QTY_VISITS END) QTY_VISITS,
        SUM(CASE WHEN V.ITE_ITEM_ID IS NOT NULL THEN QTY_VISITS_LAST_7DAYS END) QTY_VISITS_LAST_7DAYS,
        SUM(CASE WHEN V.ITE_ITEM_ID IS NOT NULL   THEN QTY_VISITS_LAST_30DAYS END) QTY_VISITS_LAST_30DAYS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_QUANTITY_AVAILABLE=0 THEN I.ITE_ITEM_ID END ) ITE_ITEM_QUANTITY_AVAILABLE,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_QUANTITY_AVAILABLE=0 AND DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 7 AND DATE(ITE_ITEM_AUCTION_START_DATETIME) < current_date() THEN ITE_ITEM_QUANTITY_AVAILABLE END )ITE_ITEM_QUANTITY_AVAILABLE_L7DAYS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_QUANTITY_AVAILABLE=0 AND DATE(ITE_ITEM_AUCTION_START_DATETIME) >= CURRENT_DATE - 30 AND DATE(ITE_ITEM_AUCTION_START_DATETIME) < current_date() THEN ITE_ITEM_QUANTITY_AVAILABLE END )ITE_ITEM_QUANTITY_AVAILABLE_L30DAYS,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CATALOG_LISTING_FLG=true AND ITE_ITEM_STATUS = 'active' AND CONCAT(I.SIT_SITE_ID,I.ITE_ITEM_ID) NOT IN (select coalesce(ITEM_ID,'0') from `meli-bi-data.WHOWNER.LK_BUYBOX_PRODUCT_STATUS`,UNNEST(ITE_ITEM_ID_WINNERS_SHARE)  ) THEN I.ITE_ITEM_ID END) AS ITEMS_LOSING_BB,
        COUNT(DISTINCT CASE WHEN ITE_ITEM_CATALOG_LISTING_FLG=true AND ITE_ITEM_STATUS = 'active' AND CONCAT(I.SIT_SITE_ID,I.ITE_ITEM_ID)  IN (select ITEM_ID from `meli-bi-data.WHOWNER.LK_BUYBOX_PRODUCT_STATUS`,UNNEST(ITE_ITEM_ID_WINNERS_SHARE) ) THEN I.ITE_ITEM_ID END) AS ITEMS_WINNER_BB

   FROM `meli-bi-data.WHOWNER.LK_ITE_ITEMS` I
LEFT JOIN  `meli-bi-data.WHOWNER.LK_CURRENCY_CONVERTION` F
   ON TRIM(F.SIT_SITE_ID) = I.SIT_SITE_ID
     AND tim_day_tc= CURRENT_DATE
LEFT JOIN EXPLOTACION.STAGING_DM_SELLERS_VISITS V
  ON V.SIT_SITE_ID = I.SIT_SITE_ID
  AND V.ITE_ITEM_ID=I.ITE_ITEM_ID
    WHERE IS_TEST = FALSE
        AND I.SIT_SITE_ID IN ('MLA','MLC','MLB','MLM','MLU','MCO','MPE','MLV')
        AND ITE_ITEM_BUYING_MODE != 'classified'
    GROUP BY 1,2
);

